     1                                  extern printf
     2                                  
     3                                  extern fgets
     4                                  
     5                                  extern stdin
     6                                  
     7                                  extern strlen
     8                                  
     9                                  extern scanf
    10                                  
    11                                  global average
    12                                  
    13                                  name_string_size equ 48
    14                                  
    15                                  segment .data
    16 00000000 506C6561736520656E-         prompt_your_name db "Please enter your first and last names: ", 0
    16 00000009 74657220796F757220-
    16 00000012 666972737420616E64-
    16 0000001B 206C617374206E616D-
    16 00000024 65733A2000         
    17 00000029 506C6561736520656E-         prompt_your_title db "Please enter your title such as Lieutenant, Chief, Mr, Ms, Influencer, Chairman, Freshman, Foreman, Project Leader, etc: ", 0
    17 00000032 74657220796F757220-
    17 0000003B 7469746C6520737563-
    17 00000044 68206173204C696575-
    17 0000004D 74656E616E742C2043-
    17 00000056 686965662C204D722C-
    17 0000005F 204D732C20496E666C-
    17 00000068 75656E6365722C2043-
    17 00000071 686169726D616E2C20-
    17 0000007A 46726573686D616E2C-
    17 00000083 20466F72656D616E2C-
    17 0000008C 2050726F6A65637420-
    17 00000095 4C65616465722C2065-
    17 0000009E 74633A2000         
    18 000000A3 5468616E6B20796F75-         thank_you db "Thank you %s %s", 0ah, 0ah, 0
    18 000000AC 2025732025730A0A00 
    19                                  
    20 000000B5 456E74657220746865-         prompt_miles_fullerton_santaana db "Enter the number of miles travled from Fullerton to Santa Ana: ", 0
    20 000000BE 206E756D626572206F-
    20 000000C7 66206D696C65732074-
    20 000000D0 7261766C6564206672-
    20 000000D9 6F6D2046756C6C6572-
    20 000000E2 746F6E20746F205361-
    20 000000EB 6E746120416E613A20-
    20 000000F4 00                 
    21 000000F5 456E74657220796F75-         prompt_average_speed_fullerton_santaana db "Enter your average speed during that leg of the trip: ",0
    21 000000FE 722061766572616765-
    21 00000107 207370656564206475-
    21 00000110 72696E672074686174-
    21 00000119 206C6567206F662074-
    21 00000122 686520747269703A20-
    21 0000012B 00                 
    22                                  
    23 0000012C 0A456E746572207468-         prompt_miles_santaana_longbeach db 0ah, "Enter the number of miles traveled from Santa Ana to Long Beach: ", 0
    23 00000135 65206E756D62657220-
    23 0000013E 6F66206D696C657320-
    23 00000147 74726176656C656420-
    23 00000150 66726F6D2053616E74-
    23 00000159 6120416E6120746F20-
    23 00000162 4C6F6E672042656163-
    23 0000016B 683A2000           
    24 0000016F 456E74657220796F75-         prompt_average_speed_santaana_longbeach db "Enter your average speed during that leg of the trip: ", 0
    24 00000178 722061766572616765-
    24 00000181 207370656564206475-
    24 0000018A 72696E672074686174-
    24 00000193 206C6567206F662074-
    24 0000019C 686520747269703A20-
    24 000001A5 00                 
    25                                  
    26 000001A6 0A456E746572207468-         prompt_miles_longbeach_fullerton db 0ah, "Enter the number of miles travled from Long Beach to Fullerton: ", 0
    26 000001AF 65206E756D62657220-
    26 000001B8 6F66206D696C657320-
    26 000001C1 747261766C65642066-
    26 000001CA 726F6D204C6F6E6720-
    26 000001D3 426561636820746F20-
    26 000001DC 46756C6C6572746F6E-
    26 000001E5 3A2000             
    27 000001E8 456E74657220796F75-         prompt_average_speed_longbeach_fullerton db "Enter your average speed during that leg of the trip: ", 0
    27 000001F1 722061766572616765-
    27 000001FA 207370656564206475-
    27 00000203 72696E672074686174-
    27 0000020C 206C6567206F662074-
    27 00000215 686520747269703A20-
    27 0000021E 00                 
    28                                  
    29 0000021F 0A54686520696E7075-         processing_msg db 0ah, "The inputted data are being processed ", 0ah, 0ah, 0
    29 00000228 747465642064617461-
    29 00000231 20617265206265696E-
    29 0000023A 672070726F63657373-
    29 00000243 6564200A0A00       
    30                                  
    31 00000249 54686520746F74616C-         result_total_distance db "The total distance traveled is %0.2lf miles. ", 10, 0
    31 00000252 2064697374616E6365-
    31 0000025B 2074726176656C6564-
    31 00000264 2069732025302E326C-
    31 0000026D 66206D696C65732E20-
    31 00000276 0A00               
    32 00000278 5468652074696D6520-         result_total_time db "The time of the trip is %0.2lf hours", 10, 0
    32 00000281 6F6620746865207472-
    32 0000028A 69702069732025302E-
    32 00000293 326C6620686F757273-
    32 0000029C 0A00               
    33 0000029E 546865206176657261-         result_average_speed db "The average speed during this trip is %0.2lf mph. ", 0ah, 0ah, 0
    33 000002A7 676520737065656420-
    33 000002B0 647572696E67207468-
    33 000002B9 697320747269702069-
    33 000002C2 732025302E326C6620-
    33 000002CB 6D70682E200A0A00   
    34                                  
    35 000002D3 256C6600                    number_input db "%lf", 0
    36 000002D7 0000000000000840            amount_of_speeds dq 3.0
    37 000002DF 0000000000000000            total_distance dq 0.0
    38 000002E7 0000000000000000            total_time dq 0.0
    39 000002EF 0000000000000000            average_speed dq 0.0
    40                                  
    41                                  segment .bss
    42                                      align 64
    43 00000000 <res 340h>                  backup_storage_area resb 832
    44                                  
    45 00000340 <res 30h>                   user_name resb name_string_size
    46 00000370 <res 30h>                   user_title resb name_string_size
    47                                      
    48                                  segment .text
    49                                  
    50                                  average:
    51                                      
    52                                  ;Back up the GPRs (General Purpose Registers)
    53 00000000 55                      push rbp
    54 00000001 4889E5                  mov rbp, rsp
    55 00000004 53                      push rbx
    56 00000005 51                      push rcx
    57 00000006 52                      push rdx
    58 00000007 57                      push rdi
    59 00000008 56                      push rsi
    60 00000009 4150                    push r8
    61 0000000B 4151                    push r9
    62 0000000D 4152                    push r10
    63 0000000F 4153                    push r11
    64 00000011 4154                    push r12
    65 00000013 4155                    push r13
    66 00000015 4156                    push r14
    67 00000017 4157                    push r15
    68 00000019 9C                      pushf
    69                                  
    70                                  ;Backup the registers other than the GPRs
    71 0000001A B807000000              mov rax,7
    72 0000001F BA00000000              mov rdx,0
    73 00000024 0FAE2425[00000000]      xsave [backup_storage_area]
    74                                  
    75                                  ;Output prompt for your name
    76 0000002C B800000000              mov rax, 0
    77 00000031 48BF-                   mov rdi, prompt_your_name
    77 00000033 [0000000000000000] 
    78 0000003B E8(00000000)            call printf
    79                                  
    80                                  ;Input your name 
    81 00000040 B800000000              mov rax, 0
    82 00000045 48BF-                   mov rdi, user_name
    82 00000047 [4003000000000000] 
    83 0000004F BE30000000              mov rsi, name_string_size
    84 00000054 488B1425[00000000]      mov rdx, [stdin]
    85 0000005C E8(00000000)            call fgets
    86                                  
    87                                  ;Remove newline
    88 00000061 B800000000              mov rax, 0
    89 00000066 48BF-                   mov rdi, user_name
    89 00000068 [4003000000000000] 
    90 00000070 E8(00000000)            call strlen
    91 00000075 C680[3F030000]00        mov [user_name+rax-1], byte 0
    92                                  
    93                                  ;Output prompt for your title
    94 0000007C B800000000              mov rax, 0
    95 00000081 48BF-                   mov rdi, prompt_your_title
    95 00000083 [2900000000000000] 
    96 0000008B E8(00000000)            call printf
    97                                  
    98                                  ;Input your title 
    99 00000090 B800000000              mov rax, 0 
   100 00000095 48BF-                   mov rdi, user_title
   100 00000097 [7003000000000000] 
   101 0000009F BE30000000              mov rsi, name_string_size
   102 000000A4 488B1425[00000000]      mov rdx, [stdin]
   103 000000AC E8(00000000)            call fgets
   104                                  
   105                                  ;Remove newline
   106 000000B1 B800000000              mov rax, 0
   107 000000B6 48BF-                   mov rdi, user_title
   107 000000B8 [7003000000000000] 
   108 000000C0 E8(00000000)            call strlen
   109 000000C5 C680[6F030000]00        mov [user_title+rax-1], byte 0
   110                                  
   111                                  ;Output a personalized thank you message 
   112 000000CC B800000000              mov rax, 0
   113 000000D1 48BF-                   mov rdi, thank_you
   113 000000D3 [A300000000000000] 
   114 000000DB 48BE-                   mov rsi, user_title
   114 000000DD [7003000000000000] 
   115 000000E5 48BA-                   mov rdx, user_name
   115 000000E7 [4003000000000000] 
   116 000000EF E8(00000000)            call printf
   117                                  
   118                                  
   119                                  ;Fullerton to Santa Ana
   120                                  
   121                                  
   122                                  ;Output prompt miles traveled(Fullerton to Santa Ana)
   123 000000F4 B800000000              mov rax, 0
   124 000000F9 48BF-                   mov rdi, prompt_miles_fullerton_santaana
   124 000000FB [B500000000000000] 
   125 00000103 E8(00000000)            call printf 
   126                                  
   127                                  ;Input miles traveled (Fullerton to Santa Ana)
   128 00000108 B800000000              mov rax, 0
   129 0000010D 48BF-                   mov rdi, number_input
   129 0000010F [D302000000000000] 
   130 00000117 6AF7                    push qword -9
   131 00000119 6AF7                    push qword -9
   132 0000011B 4889E6                  mov rsi, rsp
   133                                  ;mov rdx, [stdin]
   134                                  ;all fgets
   135 0000011E E8(00000000)            call scanf
   136 00000123 F2440F100424            movsd xmm8, [rsp]
   137 00000129 4159                    pop r9
   138 0000012B 4158                    pop r8
   139                                  
   140                                  ;Addition of first distance
   141 0000012D B800000000              mov rax, 0 
   142 00000132 F2440F103425-           movsd xmm14, qword [total_distance]
   142 00000138 [DF020000]         
   143 0000013C F2450F58F0              addsd xmm14, xmm8
   144                                  
   145                                  
   146                                  ;Output prompt average speed(Fullerton to Santa Ana)
   147 00000141 B800000000              mov rax, 0
   148 00000146 48BF-                   mov rdi, prompt_average_speed_fullerton_santaana
   148 00000148 [F500000000000000] 
   149 00000150 E8(00000000)            call printf 
   150                                  
   151                                  ;Input average speed(Fullerton to Santa Ana)
   152 00000155 B800000000              mov rax, 0
   153 0000015A 48BF-                   mov rdi, number_input
   153 0000015C [D302000000000000] 
   154 00000164 6AF7                    push qword -9
   155 00000166 6AF7                    push qword -9
   156 00000168 4889E6                  mov rsi, rsp
   157                                  ;mov rdx, [stdin]
   158                                  ;call fgets
   159 0000016B E8(00000000)            call scanf
   160 00000170 F2440F100C24            movsd xmm9, [rsp]
   161 00000176 4159                    pop r9
   162 00000178 4158                    pop r8
   163                                  
   164                                  ;Addition of first average speed
   165 0000017A B800000000              mov rax, 0
   166 0000017F F2440F103C25-           movsd xmm15, qword[average_speed]
   166 00000185 [EF020000]         
   167 00000189 F2450F58F9              addsd xmm15, xmm9
   168                                  
   169                                  
   170                                  
   171                                  
   172                                  
   173                                  ;Santa Ana to Long Beach
   174                                  
   175                                  ;Output prompt for miles traveled (Santa Ana to Long Beach)
   176 0000018E B800000000              mov rax, 0
   177 00000193 48BF-                   mov rdi, prompt_miles_santaana_longbeach
   177 00000195 [2C01000000000000] 
   178 0000019D E8(00000000)            call printf 
   179                                  
   180                                  ;Input miles traveled (Santa Ana to Long Beach)
   181 000001A2 B800000000              mov rax, 0
   182 000001A7 48BF-                   mov rdi, number_input
   182 000001A9 [D302000000000000] 
   183 000001B1 6AF7                    push qword -9
   184 000001B3 6AF7                    push qword -9
   185 000001B5 4889E6                  mov rsi, rsp
   186                                  ;mov rdx, [stdin]
   187                                  ;call fgets
   188 000001B8 E8(00000000)            call scanf
   189 000001BD F2440F101424            movsd xmm10, [rsp]
   190 000001C3 4159                    pop r9
   191 000001C5 4158                    pop r8
   192                                  
   193                                  ;Addition of second distance
   194 000001C7 B800000000              mov rax, 0
   195 000001CC F2450F58F2              addsd xmm14, xmm10
   196                                  
   197                                  ;Output prompt average speed(Santa Ana to Long Beach)
   198 000001D1 B800000000              mov rax, 0
   199 000001D6 48BF-                   mov rdi, prompt_average_speed_santaana_longbeach
   199 000001D8 [6F01000000000000] 
   200 000001E0 E8(00000000)            call printf 
   201                                  
   202                                  ;Input average speed(Santa Ana to Long Beach)
   203 000001E5 B800000000              mov rax, 0
   204 000001EA 48BF-                   mov rdi, number_input
   204 000001EC [D302000000000000] 
   205 000001F4 6AF7                    push qword -9
   206 000001F6 6AF7                    push qword -9
   207 000001F8 4889E6                  mov rsi, rsp
   208                                  ;mov rdx, [stdin]
   209                                  ;call fgets
   210 000001FB E8(00000000)            call scanf
   211 00000200 F2440F101C24            movsd xmm11, [rsp]
   212 00000206 4159                    pop r9
   213 00000208 4158                    pop r8
   214                                  
   215                                  ;Addition of second speed 
   216 0000020A B800000000              mov rax, 0
   217 0000020F F2450F58FB              addsd xmm15, xmm11
   218                                  
   219                                  
   220                                  
   221                                  
   222                                  
   223                                  
   224                                  ;Output prompt for miles traveled (Long Beach to Fullerton)
   225 00000214 B800000000              mov rax, 0
   226 00000219 48BF-                   mov rdi, prompt_miles_longbeach_fullerton
   226 0000021B [A601000000000000] 
   227 00000223 E8(00000000)            call printf 
   228                                  
   229                                  ;Input miles traveled (Long Beach to Fullerton)
   230 00000228 B800000000              mov rax, 0
   231 0000022D 48BF-                   mov rdi, number_input
   231 0000022F [D302000000000000] 
   232 00000237 6AF7                    push qword -9
   233 00000239 6AF7                    push qword -9
   234 0000023B 4889E6                  mov rsi, rsp
   235                                  ;mov rdx, [stdin]
   236                                  ;call fgets
   237 0000023E E8(00000000)            call scanf 
   238 00000243 F2440F102424            movsd xmm12, [rsp]
   239 00000249 4159                    pop r9
   240 0000024B 4158                    pop r8
   241                                  
   242                                  ;Addition of third distance
   243 0000024D B800000000              mov rax, 0
   244 00000252 F2450F58F4              addsd xmm14, xmm12
   245                                  
   246                                  
   247                                  
   248                                  ;Output prompt average speed(Long Beach to Fullerton)
   249 00000257 B800000000              mov rax, 0
   250 0000025C 48BF-                   mov rdi, prompt_average_speed_longbeach_fullerton
   250 0000025E [E801000000000000] 
   251 00000266 E8(00000000)            call printf 
   252                                  
   253                                  ;Input average speed(Long Beach to Fullerton)
   254 0000026B B800000000              mov rax, 0
   255 00000270 48BF-                   mov rdi, number_input
   255 00000272 [D302000000000000] 
   256 0000027A 6AF7                    push qword -9
   257 0000027C 6AF7                    push qword -9
   258 0000027E 4889E6                  mov rsi, rsp
   259                                  ;mov rdx, [stdin]
   260                                  ;call fgets
   261 00000281 E8(00000000)            call scanf
   262 00000286 F2440F102C24            movsd xmm13, [rsp]
   263 0000028C 4159                    pop r9
   264 0000028E 4158                    pop r8
   265                                  
   266                                  ;Addition of third speed 
   267 00000290 B800000000              mov rax, 0
   268 00000295 F2450F58FD              addsd xmm15, xmm13
   269                                  
   270                                  
   271                                  
   272                                  ;Processing message 
   273 0000029A B800000000              mov rax, 0
   274 0000029F 48BF-                   mov rdi, processing_msg
   274 000002A1 [1F02000000000000] 
   275 000002A9 E8(00000000)            call printf
   276                                  
   277                                  
   278                                  
   279                                  ; Output total distance
   280 000002AE B801000000              mov rax, 1
   281 000002B3 48BF-                   mov rdi, result_total_distance
   281 000002B5 [4902000000000000] 
   282 000002BD F2410F10C6              movsd xmm0, xmm14
   283 000002C2 E8(00000000)            call printf
   284                                  
   285                                  ;Calculate total time
   286 000002C7 B800000000              mov rax, 0
   287 000002CC F20F103C25-             movsd xmm7, qword[amount_of_speeds]
   287 000002D1 [D7020000]         
   288 000002D5 F2440F5EFF              divsd xmm15, xmm7
   289 000002DA F20F103425-             movsd xmm6, qword[total_time]
   289 000002DF [E7020000]         
   290 000002E3 F2410F10F6              movsd xmm6, xmm14
   291 000002E8 F2450F5EF7              divsd xmm14, xmm15
   292                                  
   293                                  ;Output total time
   294 000002ED B801000000              mov rax, 1
   295 000002F2 48BF-                   mov rdi, result_total_time
   295 000002F4 [7802000000000000] 
   296 000002FC F2410F10C6              movsd xmm0, xmm14
   297 00000301 E8(00000000)            call printf
   298                                  
   299                                  
   300                                  ; Output average speed
   301 00000306 B801000000              mov rax, 1
   302 0000030B 48BF-                   mov rdi, result_average_speed
   302 0000030D [9E02000000000000] 
   303 00000315 F2410F10C7              movsd xmm0, xmm15
   304 0000031A E8(00000000)            call printf
   305                                  
   306 0000031F 6A00                    push qword 0
   307 00000321 F2440F113C24            movsd [rsp], xmm15
   308                                  ;Return average speed to driver.c
   309                                  ;movsd xmm0, xmm15
   310                                  
   311                                  ;Restore the values to non-GPRs
   312 00000327 B807000000              mov rax,7
   313 0000032C BA00000000              mov rdx,0
   314 00000331 0FAE2C25[00000000]      xrstor [backup_storage_area]
   315                                  
   316 00000339 F20F100424              movsd xmm0, [rsp]
   317 0000033E 58                      pop rax
   318                                  
   319                                  ;Restore the GPRs
   320 0000033F 9D                      popf
   321 00000340 415F                    pop r15
   322 00000342 415E                    pop r14
   323 00000344 415D                    pop r13
   324 00000346 415C                    pop r12
   325 00000348 415B                    pop r11
   326 0000034A 415A                    pop r10
   327 0000034C 4159                    pop r9
   328 0000034E 4158                    pop r8
   329 00000350 5E                      pop rsi
   330 00000351 5F                      pop rdi
   331 00000352 5A                      pop rdx
   332 00000353 59                      pop rcx
   333 00000354 5B                      pop rbx
   334 00000355 5D                      pop rbp   ;Restore rbp to the base of the activation record of the caller program
   335 00000356 C3                      ret
   336                                  ;End of the function average =====================================================
